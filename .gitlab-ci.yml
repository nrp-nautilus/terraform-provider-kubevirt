stages:
  - test
  - go-test
  - fetch-github-results
  - sync-github

# Slight change for v0.1.26 testing
test:
  stage: test
  image: alpine:latest
  script:
    - echo "Hello World"
    - echo "Simple CI/CD test"
  rules:
    - if: $CI_COMMIT_TAG

go-test:
  stage: go-test
  image: golang:1.21-alpine
  before_script:
    - apk add --no-cache git wget unzip
    - wget -O terraform.zip https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
    - unzip terraform.zip
    - mv terraform /usr/local/bin/
    - terraform version
    - go mod download
    - go mod verify
  script:
    - echo "Running Go tests..."
    - go test -v ./...
    - echo "Running Go vet..."
    - go vet ./...
    - echo "Running Go fmt check..."
    - go fmt ./...
    - echo "âœ… Go tests completed successfully!"
  rules:
    - if: $CI_COMMIT_TAG

fetch-github-results:
  stage: fetch-github-results
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Phase 3 Basic GitHub API check"
    - echo "Tag check stage"
    - echo "Checking GitHub API"
    - echo "Basic test will add GitHub logic later"
    - echo "Phase 3 completed successfully"
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []

sync-github:
  stage: sync-github
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq
  script:
    - echo "Phase 4 Real GitHub sync starting HTTPS with token"
    - echo "Setting up git with GitHub token"
    - git config --global user.email "ci@gitlab.nrp-nautilus.io"
    - git config --global user.name "GitLab CI"
    - echo "Cloning GitHub repository HTTPS"
    - git clone https://x-access-token:${GITHUB_TOKEN}@github.com/nrp-nautilus/terraform-provider-kubevirt.git github-repo
    - echo "Adding GitLab as remote HTTPS"
    - git remote add gitlab https://gitlab.nrp-nautilus.io/nrp/kubevirt-terraform-provider.git
    - echo "Fetching latest from GitLab"
    - git fetch gitlab
    - echo "Pushing to GitHub main branch from GitLab working directory"
    - cd /builds/nrp/kubevirt-terraform-provider
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/nrp-nautilus/terraform-provider-kubevirt.git
    - echo "Creating new git repo with current files"
    - mkdir fresh-push
    - cd fresh-push
    - git init
    - git config user.email "ci@gitlab.nrp-nautilus.io"
    - git config user.name "GitLab CI"
    - echo "Copying source files avoiding recursion and github-repo"
    - find /builds/nrp/kubevirt-terraform-provider -maxdepth 1 -not -name fresh-push -not -name .git -not -name github-repo -exec cp -r {} . \;
    - git add .
    - git commit -m "Sync from GitLab - $(date)"
    - git branch -M main
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/nrp-nautilus/terraform-provider-kubevirt.git
    - git push github main:main --force --verbose
    - echo "Git push exit code $?"
    - echo "Git remote v output"
    - git remote -v
    - echo "Git status output"
    - git status
    - echo "Phase 4 GitHub sync completed successfully"
    - echo "Validating GitHub received our code"
    - sleep 10
    - echo "Checking GitHub API for latest commit"
    - AUTH_HEADER="Authorization token ${GITHUB_TOKEN}"
    - curl -s -H "$AUTH_HEADER" "https://api.github.com/repos/nrp-nautilus/terraform-provider-kubevirt/commits/main" > github_response.json
    - LATEST_COMMIT=$(jq -r '.sha' github_response.json)
    - echo "Latest GitHub commit"
    - echo "$LATEST_COMMIT"
    - echo "Getting original GitLab commit from tag"
    - cd /builds/nrp/kubevirt-terraform-provider
    - ORIGINAL_COMMIT=$(git rev-parse HEAD)
    - echo "Original GitLab commit"
    - echo "$ORIGINAL_COMMIT"
    - echo "Comparing commit hashes"
    - echo "GitHub commit hash"
    - echo "$LATEST_COMMIT"
    - echo "Original GitLab commit hash"
    - echo "$ORIGINAL_COMMIT"
    - echo "Checking if commits match"
    - if [ "$LATEST_COMMIT" != "$ORIGINAL_COMMIT" ]
    - then
    -   echo "ERROR GitHub commit mismatch Pipeline should fail"
    -   exit 1
    - fi
    - echo "GitHub commit validation passed"
    - echo "Checking if GitHub Actions workflow started"
    - curl -s -H "$AUTH_HEADER" "https://api.github.com/repos/nrp-nautilus/terraform-provider-kubevirt/actions/runs?per_page=1" > workflow_response.json
    - WORKFLOW_RUNS=$(jq '.workflow_runs | length' workflow_response.json)
    - echo "Workflow runs found"
    - echo "$WORKFLOW_RUNS"
    - if [ "$WORKFLOW_RUNS" -eq 0 ]
    - then
    -   echo "ERROR No GitHub Actions runs found Pipeline should fail"
    -   exit 1
    - fi
    - echo "GitHub Actions workflow found validation passed"
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []
