stages:
  - test
  - go-test
  - fetch-github-results
  - sync-github

test:
  stage: test
  image: alpine:latest
  script:
    - echo "Hello World"
    - echo "Simple CI/CD test"
  rules:
    - if: $CI_COMMIT_TAG

go-test:
  stage: go-test
  image: golang:1.21-alpine
  before_script:
    - apk add --no-cache git wget unzip
    - wget -O terraform.zip https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
    - unzip terraform.zip
    - mv terraform /usr/local/bin/
    - terraform version
    - go mod download
    - go mod verify
  script:
    - echo "Running Go tests..."
    - go test -v ./...
    - echo "Running Go vet..."
    - go vet ./...
    - echo "Running Go fmt check..."
    - go fmt ./...
    - echo "âœ… Go tests completed successfully!"
  rules:
    - if: $CI_COMMIT_TAG

fetch-github-results:
  stage: fetch-github-results
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Phase 3 Basic GitHub API check"
    - echo "Tag check stage"
    - echo "Checking GitHub API"
    - echo "Basic test will add GitHub logic later"
    - echo "Phase 3 completed successfully"
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []

sync-github:
  stage: sync-github
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - echo "Phase 4 Real GitHub sync starting HTTPS with token"
    - echo "Setting up git with GitHub token"
    - git config --global user.email "ci@gitlab.nrp-nautilus.io"
    - git config --global user.name "GitLab CI"
    - echo "Cloning GitHub repository HTTPS"
    - git clone https://x-access-token:${GITHUB_TOKEN}@github.com/nrp-nautilus/terraform-provider-kubevirt.git github-repo
    - cd github-repo
    - echo "Adding GitLab as remote HTTPS"
    - git remote add gitlab https://gitlab.nrp-nautilus.io/nrp/kubevirt-terraform-provider.git
    - echo "Fetching latest from GitLab"
    - git fetch gitlab
    - echo "Pushing to GitHub main branch"
    - git push origin gitlab/main:main --force
    - echo "Phase 4 GitHub sync completed successfully"
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []
