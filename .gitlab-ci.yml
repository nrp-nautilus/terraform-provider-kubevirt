stages:
  - test
  - go-test
  - fetch-github-results
  - sync-github

# Slight change for v0.1.26 testing
test:
  stage: test
  image: alpine:latest
  script:
    - echo "Hello World"
    - echo "Simple CI/CD test"
  rules:
    - if: $CI_COMMIT_TAG

go-test:
  stage: go-test
  image: golang:1.21-alpine
  before_script:
    - apk add --no-cache git wget unzip
    - wget -O terraform.zip https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
    - unzip terraform.zip
    - mv terraform /usr/local/bin/
    - terraform version
    - go mod download
    - go mod verify
  script:
    - echo "Running Go tests..."
    - go test -v ./...
    - echo "Running Go vet..."
    - go vet ./...
    - echo "Running Go fmt check..."
    - go fmt ./...
    - echo "âœ… Go tests completed successfully!"
  rules:
    - if: $CI_COMMIT_TAG

fetch-github-results:
  stage: fetch-github-results
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Phase 3 Basic GitHub API check"
    - echo "Tag check stage"
    - echo "Checking GitHub API"
    - echo "Basic test will add GitHub logic later"
    - echo "Phase 3 completed successfully"
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []

sync-github:
  stage: sync-github
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq
  script:
    - echo "Phase 4 Real GitHub sync starting HTTPS with token"
    - echo "Setting up git with GitHub token"
    - git config --global user.email "ci@gitlab.nrp-nautilus.io"
    - git config --global user.name "GitLab CI"
    - echo "Cloning GitHub repository HTTPS"
    - git clone https://x-access-token:${GITHUB_TOKEN}@github.com/nrp-nautilus/terraform-provider-kubevirt.git github-repo
    - echo "Adding GitLab as remote HTTPS"
    - git remote add gitlab https://gitlab.nrp-nautilus.io/nrp/kubevirt-terraform-provider.git
    - echo "Fetching latest from GitLab"
    - git fetch gitlab
    - echo "Pushing to GitHub main branch from GitLab working directory"
    - cd /builds/nrp/kubevirt-terraform-provider
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/nrp-nautilus/terraform-provider-kubevirt.git
    - echo "Creating clean repository for GitHub push"
    - mkdir clean-push
    - cd clean-push
    - git init
    - git config user.email "ci@gitlab.nrp-nautilus.io"
    - git config user.name "GitLab CI"
    - git config init.defaultBranch main
    - echo "Copying current source files avoiding recursion"
    - find /builds/nrp/kubevirt-terraform-provider -maxdepth 1 -not -name clean-push -not -name .git -not -name github-repo -not -name kubevirt-terraform-provider -exec cp -r {} . \;
    - echo "Cleaning up any git artifacts and problematic files"
    - rm -rf .git github-repo kubevirt-terraform-provider clean-push 2>/dev/null || true
    - rm -rf .terraform .terraform.lock.hcl 2>/dev/null || true
    - rm -rf bin/ dist/ build/ 2>/dev/null || true
    - echo "Removing any hidden files that might cause issues"
    - find . -name ".*" -type f -not -name ".gitignore" -not -name ".github" -not -name ".gitlab-ci.yml" -delete 2>/dev/null || true
    - echo "Final cleanup - removing any remaining problematic directories"
    - rm -rf node_modules/ vendor/ .cache/ .tmp/ 2>/dev/null || true
    - echo "Adding files to git"
    - git add .
    - echo "Files staged for commit:"
    - git status --porcelain
    - echo "Total files to be committed:"
    - git diff --cached --name-only | wc -l
    - echo "Committing clean repository"
    - git commit -m "Sync from GitLab - $(date)"
    - echo "Git status after commit"
    - git status
    - echo "Git branch after commit"
    - git branch -a
    - echo "Creating main branch from current commit"
    - git checkout -b main
    - echo "Git status after branch creation"
    - git status
    - echo "Git branch after branch creation"
    - git branch -a
    - echo "Pushing to GitHub"
    - git push github main:main --force --verbose
    - echo "Git push exit code $?"
    - echo "Git remote v output"
    - git remote -v
    - echo "Git status output"
    - git status
    - echo "Phase 4 GitHub sync completed successfully"
    - echo "Validating GitHub received our code"
    - sleep 10
    - echo "Checking GitHub API for latest commit"
    - AUTH_HEADER="Authorization token ${GITHUB_TOKEN}"
    - echo "Making GitHub API request"
    - curl -s -H "$AUTH_HEADER" "https://api.github.com/repos/nrp-nautilus/terraform-provider-kubevirt/commits/main" > github_response.json
    - echo "Checking if GitHub API response is valid"
    - if [ ! -s github_response.json ]; then
    -   echo "ERROR GitHub API returned empty response"
    -   exit 1
    - fi
    - echo "Parsing GitHub commit hash"
    - LATEST_COMMIT=$(jq -r '.sha' github_response.json)
    - echo "Latest GitHub commit"
    - echo "$LATEST_COMMIT"
    - echo "Checking if commit hash is valid"
    - if [ "$LATEST_COMMIT" = "null" ] || [ -z "$LATEST_COMMIT" ]; then
    -   echo "ERROR Invalid GitHub commit hash received"
    -   exit 1
    - fi
    - echo "Current GitLab commit"
    - cd /builds/nrp/kubevirt-terraform-provider
    - CURRENT_COMMIT=$(git rev-parse HEAD)
    - echo "$CURRENT_COMMIT"
    - echo "Comparing commit hashes"
    - echo "GitHub commit hash"
    - echo "$LATEST_COMMIT"
    - echo "GitLab commit hash"
    - echo "$CURRENT_COMMIT"
    - echo "Checking if GitHub got our new code"
    - if [ "$LATEST_COMMIT" != "$CURRENT_COMMIT" ]
    - then
    -   echo "ERROR GitHub did not get our new code Pipeline should fail"
    -   exit 1
    - fi
    - echo "GitHub commit validation passed - GitHub got our new code"
    - echo "Checking if GitHub Actions workflow started"
    - curl -s -H "$AUTH_HEADER" "https://api.github.com/repos/nrp-nautilus/terraform-provider-kubevirt/actions/runs?per_page=1" > workflow_response.json
    - WORKFLOW_RUNS=$(jq '.workflow_runs | length' workflow_response.json)
    - echo "Workflow runs found"
    - echo "$WORKFLOW_RUNS"
    - if [ "$WORKFLOW_RUNS" -eq 0 ]
    - then
    -   echo "ERROR No GitHub Actions runs found Pipeline should fail"
    -   exit 1
    - fi
    - echo "GitHub Actions workflow found validation passed"
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []
